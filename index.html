<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AR Utilities Demo - GPS AR </title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js GPS -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.2/aframe/build/aframe-ar.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #map { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
    a-scene { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
  </style>
</head>
<body>

  <!-- Leaflet Satellite Map -->
  <div id="map"></div>

  <!-- AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    arjs="trackingMethod: gps; sourceType: webcam; debugUIEnabled: false; facingMode: environment;">
    
    <a-camera gps-camera rotation-reader></a-camera>

    <!-- 3D GIS Markers -->
    <a-box gps-entity-place="latitude:23.8103; longitude:90.4125"
           color="blue" depth="1" height="2" width="1"></a-box>

    <a-sphere gps-entity-place="latitude:23.8110; longitude:90.4130"
              color="red" radius="1.2"></a-sphere>

    <a-cone gps-entity-place="latitude:23.8115; longitude:90.4120"
            color="yellow" radius-bottom="0.5" height="1.5"></a-cone>

    <a-cylinder gps-entity-place="latitude:23.8108; longitude:90.4135"
                color="green" radius="0.4" height="1.5"></a-cylinder>

    <a-box gps-entity-place="latitude:23.8112; longitude:90.4140"
           color="purple" depth="0.8" height="1.5" width="0.8"></a-box>

    <a-sphere gps-entity-place="latitude:23.8105; longitude:90.4142"
              color="orange" radius="1"></a-sphere>

    <a-cone gps-entity-place="latitude:23.8109; longitude:90.4128"
            color="cyan" radius-bottom="0.4" height="1.2"></a-cone>

    <a-cylinder gps-entity-place="latitude:23.8113; longitude:90.4132"
                color="magenta" radius="0.3" height="1.0"></a-cylinder>

    <a-box gps-entity-place="latitude:23.8107; longitude:90.4120"
           color="pink" depth="0.7" height="1.2" width="0.7"></a-box>

    <a-sphere gps-entity-place="latitude:23.8111; longitude:90.4138"
              color="lime" radius="0.9"></a-sphere>

    <!-- User Live Location Icon -->
    <a-sphere id="user-location" color="gold" radius="0.5"></a-sphere>

  </a-scene>

  <script>
    // ================= Leaflet Satellite Map =================
    const map = L.map('map').setView([23.8103, 90.4125], 16);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics',
      maxZoom: 19,
    }).addTo(map);

    // Optional: Leaflet markers same as AR markers
    const arMarkers = [
      {lat:23.8103, lng:90.4125, color:'blue'},
      {lat:23.8110, lng:90.4130, color:'red'},
      {lat:23.8115, lng:90.4120, color:'yellow'},
      {lat:23.8108, lng:90.4135, color:'green'},
      {lat:23.8112, lng:90.4140, color:'purple'},
      {lat:23.8105, lng:90.4142, color:'orange'},
      {lat:23.8109, lng:90.4128, color:'cyan'},
      {lat:23.8113, lng:90.4132, color:'magenta'},
      {lat:23.8107, lng:90.4120, color:'pink'},
      {lat:23.8111, lng:90.4138, color:'lime'}
    ];

    arMarkers.forEach(m => {
      L.circleMarker([m.lat, m.lng], {radius:8, color:m.color}).addTo(map);
    });

    // ================= User Live Location in AR =================
    const userLocationEntity = document.getElementById('user-location');

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          // Update GPS position of live location sphere
          userLocationEntity.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon}`);
          console.log("Live location updated:", lat, lon);
        },
        (err) => console.error("Location error:", err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    // ================= Camera Permission Check =================
    async function checkPermissions() {
      try {
        const camPerm = await navigator.permissions.query({ name: "camera" });
        if (camPerm.state !== "granted") alert("Camera permission needed.");
      } catch(e) {
        alert("Your browser may not support permissions.");
      }
    }
    window.onload = checkPermissions;
  </script>

</body>
</html>
